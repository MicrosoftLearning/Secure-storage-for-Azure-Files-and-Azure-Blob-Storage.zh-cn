---
lab:
  title: 练习 04：为新的公司应用提供存储
  module: Guided Project - Azure Files and Azure Blobs
---
该公司正在设计和开发一款新应用。 开发人员需要确保仅使用密钥和托管标识访问存储。 开发人员希望使用基于角色的访问控制。 为了帮助进行测试，需要受保护的不可变存储。 

## 体系结构关系图

![包含存储帐户、托管标识和密钥保管库的示意图。](../Media/task-5.png)

## 技能任务

- 创建存储帐户和托管标识。
- 使用密钥保管库和密钥保护对存储帐户的访问。
- 将存储帐户配置为使用密钥保管库中的客户管理的密钥
- 配置基于时间的保留策略和加密范围。

## 练习说明

## 创建存储帐户和托管标识

1. 为 Web 应用提供存储帐户。 
    - 在门户中，搜索并选择“存储帐户”。 
    - 选择“+ 新建”。
    - 对于“资源组”****，选择“新建”****。 为资源组指定一个名称****，然后选择“确定”**** 以保存更改。
    - 提供存储帐户名称****。 确保名称是唯一的且符合命名要求。 
    - 查看****，然后创建**** 存储帐户。
    - 等待资源部署完毕。

1. 提供托管标识以供 Web 应用使用。  详细了解[托管标识](https://learn.microsoft.com/azure/active-directory/managed-identities-azure-resources/overview)。

    - 搜索并选择“托管标识”****。
    - 选择**创建**。
        - 选择**资源组**。 
        - 为托管标识命名。
    - 选择“查看并创建”****，然后选择“创建”****。 

1. 为托管标识分配正确的权限。 标识只需读取和列出容器和 Blob。 详细了解[如何分配 Azure 角色](https://learn.microsoft.com/azure/role-based-access-control/role-assignments-portal)。
    
    - 搜索并选择“存储帐户”****。
    - 选择“访问控制(IAM)”边栏选项卡。
    - 选择“添加角色分配”****（页面中心）。
    - 在“工作职能角色”**** 页上，搜索并选择“存储 Blob 数据读取者”**** 角色。 
    - 在“成员”**** 页上，选择“托管标识”****。
    - 选择“选择成员”****，在“托管标识”**** 下拉列表中选择“用户分配的托管标识”****。
    - 选择上一步中创建的托管标识。 
    - 单击“选择”，然后单击“查看+分配”角色********。 
    - 再次选择“查看 + 分配”**** 以添加角色分配。
    - 现在，可以通过具有存储数据 Blob 读取者权限的托管标识访问存储帐户。 

## 使用密钥保管库和密钥保护对存储帐户的访问

1. 要创建实验室中此部分所需的密钥保管库和密钥，用户帐户必须具有密钥保管库管理员权限。 详细了解如何[使用 Azure 基于角色的访问控制提供对密钥保管库密钥、证书和机密的访问权限](https://learn.microsoft.com/azure/key-vault/general/rbac-guide?tabs=azure-cli)
    - 在门户中，搜索并选择“资源组”。 
    - 选择“资源组”****，然后选择“访问控制 (IAM)”**** 边栏选项卡。
    - 选择“添加角色分配”****（页面中心）。
    - 在“工作职能角色”**** 页上，搜索并选择“密钥保管库管理员”**** 角色。
    - 在“成员”**** 页上，选择“用户、组或服务主体”****。
    - 选择“选择成员”。
    - 搜索并选择用户帐户。 用户帐户显示在门户的右上角。
    - 单击“选择”****，然后单击“查看 + 分配”****。
    - 再次选择“查看 + 分配”**** 以添加角色分配。
    - 你现在可以继续完成实验室了。

1. 创建密钥保管库来存储访问密钥。 

    - 在门户中，搜索并选择“密钥保管库”****。
    - 选择**创建**。
    - 选择**资源组**。
    - 提供密钥保管库的名称****。 名称必须唯一。 
    - 选择“查看 + 创建”。
    - 等待验证检查完成，然后选择“创建”****。
    - 部署完成后，选择“转到资源”****。
    - 在“概述”**** 边栏选项卡上，确保“软删除”**** 和“清除保护”**** 均为“已启用”****。 

1. 在密钥保管库中创建客户管理的密钥。 

    - 在“密钥保管库”**** 的“对象”**** 部分中，选择“密钥”**** 边栏选项卡。
    - 选择“生成/导入”**** 并命名**** 密钥。
    - 对其余参数使用默认值，然后单击“创建”以创建密钥****。

## 将存储帐户配置为使用密钥保管库中的客户管理的密钥

1. 在完成后续步骤之前，必须将“密钥保管库加密服务加密用户”角色分配给托管标识。 详细了解如何[使用系统分配的托管标识来授权访问](https://learn.microsoft.com/azure/storage/common/customer-managed-keys-configure-existing-account?tabs=azure-portal#use-a-system-assigned-managed-identity-to-authorize-access)
    - 在门户中，搜索并选择“资源组”。 
    - 选择“资源组”****，然后选择“访问控制 (IAM)”**** 边栏选项卡。
    - 选择“添加角色分配”****（页面中心）。
    - 在“工作职能角色”**** 页上，搜索并选择“密钥保管库加密服务加密用户”**** 角色。
    - 在“成员”**** 页上，选择“托管标识”****。
    - 选择“选择成员”****，在“托管标识”**** 下拉列表中选择“用户分配的托管标识”****。
    - 选择托管标识。  
    - 单击“选择”****，然后单击“查看 + 分配”****。
    - 再次选择“查看 + 分配”**** 以添加角色分配。
    
1. 将存储帐户配置为使用密钥保管库中的客户管理的密钥。 详细了解[现有存储帐户上的客户管理的密钥](https://learn.microsoft.com/azure/storage/common/customer-managed-keys-configure-existing-account?WT.mc_id=Portal-Microsoft_Azure_Storage&tabs=azure-portal)。
    - 返回到存储帐户。
    - 在“安全 + 网络”**** 部分，选择“加密”**** 边栏选项卡。
    - 选择“客户管理的密钥”****。
    - **选择“密钥保管库和密钥”**。 选择“密钥保管库和密钥”。
    - 单击“选择”**** 以确认所做选择。 
    - 确保“标识类型”**** 为“用户分配”****。
    - 选择标识****。
    - 选择“托管标识”，然后选择“添加”****。 
    - **保存**所做更改。
    - 如果收到错误消息，指出标识没有正确权限，请稍等片刻后再重试。 

## 配置基于时间的保留策略和加密范围。

1. 开发人员需要一种存储容器，即使管理员也无法修改其中的文件。 详细了解 [Blob 不可变存储](https://learn.microsoft.com/azure/storage/blobs/immutable-storage-overview)。

    - 导航到“存储帐户”****。
    - 在“数据存储”**** 部分中，选择“容器”**** 边栏选项卡。 
    - 创建名为 hold**** 的容器。 采用默认值。 请务必创建**** 容器。 
    - 将文件上传到容器。 
    - 在“设置”**** 部分中，选择“访问策略”**** 边栏选项卡。 
    - 在“不可变 Blob 存储”**** 部分中，选择“+ 添加策略”****。 
    - 对于“策略类型”，请选择“基于时间的保留期”********。 
    - 将保持期设置为 5 天********。 
    - 务必保存你的更改。 
    - 尝试删除**** 容器中的文件。 
    - 验证是否收到通知，指出因为策略而导致无法删除 Blob****。  

1. 开发人员需要加密范围以启用基础结构加密。 详细了解[基础结构加密](https://learn.microsoft.com/azure/storage/common/infrastructure-encryption-enable?tabs=portal)。

    - 导航回你的存储帐户。 
    - 在“安全 + 网络”**** 边栏选项卡中，选择“加密”****。
    - 在“加密范围”**** 选项卡中，选择“添加”****。
    - 为加密范围指定一个名称****。 
    - “加密类型”**** 为“Microsoft 管理的密钥”****。
    - 将“基础结构加密”**** 设置为“启用”****。
    - 请注意警告：创建范围后无法更改启用基础结构加密的设置。
    - 创建**** 加密范围。
    - 返回到存储帐户并新建容器。
    - 请注意，“新建容器”**** 页上有“名称”**** 和“公共访问级别”****。
    - 请注意，在“高级”**** 部分中，可以选择创建的“加密范围”**** 并将其应用于容器中的所有 Blob。 


>**备注**：如需进行额外练习，请完成[使用用网络安全组和服务终结点来保护和隔离对 Azure 资源的访问](https://learn.microsoft.com/training/modules/secure-and-isolate-with-nsg-and-service-endpoints/)模块。 该模块有一个沙盒，可在其中进一步练习限制对存储的访问。
